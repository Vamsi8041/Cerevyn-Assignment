{% extends "base.html" %}

{% block content %}
<div class="row g-4">
    <div class="col-lg-5">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h2 class="h5 mb-3">Geo-Fence Overview</h2>
                {% if geofence %}
                    <p class="small text-muted">
                        <strong>{{ geofence.name }}</strong><br>
                        Lat: {{ '%.5f'|format(geofence.center_lat) }},
                        Lng: {{ '%.5f'|format(geofence.center_lng) }}<br>
                        Radius: {{ geofence.radius_m|int }} m
                    </p>
                    <div id="map-admin" style="height:260px;" class="rounded"></div>
                {% else %}
                    <p class="text-muted small">No geofence configured yet.</p>
                {% endif %}
                <a href="{{ url_for('admin_geofence') }}" class="btn btn-sm btn-primary mt-3">
                    Configure Geo-Fence
                </a>
            </div>
        </div>
    </div>
    <div class="col-lg-7">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h2 class="h5 mb-3">Users</h2>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Joined</th>
                            <th>Movement</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for u in users %}
                            <tr>
                                <td>{{ u.name }}</td>
                                <td>{{ u.email }}</td>
                                <td>
                                    <span class="badge bg-secondary text-uppercase">{{ u.role }}</span>
                                </td>
                                <td class="small text-muted">{{ u.created_at.strftime('%d %b %Y') }}</td>
                                <td>
                                    <a href="{{ url_for('user_movement', user_id=u.id) }}" class="btn btn-outline-secondary btn-sm">
                                        View map
                                    </a>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-muted small">No users yet.</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-lg-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <h2 class="h6 mb-3">Latest attendance events</h2>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead>
                        <tr>
                            <th>User</th>
                            <th>Date</th>
                            <th>Check-In</th>
                            <th>Check-Out</th>
                            <th>Status</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for a in latest_attendance %}
                            <tr>
                                <td>{{ a.user.name }}</td>
                                <td>{{ a.date.strftime('%d %b %Y') }}</td>
                                <td>
                                    {% if a.check_in_time %}
                                        {{ a.check_in_time.strftime('%H:%M') }} UTC
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if a.check_out_time %}
                                        {{ a.check_out_time.strftime('%H:%M') }} UTC
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>{{ a.status or '-' }}</td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-muted small">No attendance records yet.</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    window.GEOFENCE_ADMIN = {
        hasGeofence: {{ 'true' if geofence else 'false' }},
        centerLat: {{ geofence.center_lat if geofence else 'null' }},
        centerLng: {{ geofence.center_lng if geofence else 'null' }},
        radiusM: {{ geofence.radius_m if geofence else 'null' }}
    };
</script>
{% endblock %}
