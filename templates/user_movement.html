{% extends "base.html" %}

{% block content %}
<div class="row g-4">
    <div class="col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h2 class="h5 mb-3">Movement · {{ user.name }}</h2>
                <form method="get" class="row g-2">
                    <div class="col-8">
                        <label class="form-label small">Date</label>
                        <input type="date" name="date" value="{{ target_date.isoformat() }}" class="form-control form-control-sm">
                    </div>
                    <div class="col-4 d-flex align-items-end">
                        <button class="btn btn-primary btn-sm w-100" type="submit">Go</button>
                    </div>
                </form>
                <hr>
                <p class="small text-muted mb-2">
                    Total pings: {{ pings|length }}
                </p>
                <ul class="list-group list-group-flush small">
                    {% for p in pings %}
                        <li class="list-group-item d-flex justify-content-between">
                            <span>{{ p.timestamp.strftime('%H:%M:%S') }}</span>
                            <span class="text-muted">
                                {% if p.inside_geofence %}IN{% else %}OUT{% endif %}
                            </span>
                        </li>
                    {% else %}
                        <li class="list-group-item text-muted small">
                            No movement logged for this date.
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    <div class="col-lg-8">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h2 class="h6 mb-3">Movement Map · {{ target_date.strftime('%d %b %Y') }}</h2>
                <div id="map-movement" style="height:420px;" class="rounded"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Build JS array from Jinja loop (no Python-style list comprehension)
    window.MOVEMENT_POINTS = [
        {% for p in pings %}
        {
            "lat": {{ p.lat|tojson }},
            "lng": {{ p.lng|tojson }},
            "inside": {{ p.inside_geofence|tojson }},
            "time": {{ p.timestamp.strftime('%H:%M:%S')|tojson }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    window.MOVEMENT_GEOFENCE = {
        hasGeofence: {{ (geofence is not none)|tojson }},
        centerLat: {% if geofence %}{{ geofence.center_lat|tojson }}{% else %}null{% endif %},
        centerLng: {% if geofence %}{{ geofence.center_lng|tojson }}{% else %}null{% endif %},
        radiusM: {% if geofence %}{{ geofence.radius_m|tojson }}{% else %}null{% endif %}
    };
</script>
{% endblock %}
